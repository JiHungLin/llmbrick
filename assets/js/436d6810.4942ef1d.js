"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[943],{833:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>p,contentTitle:()=>c,default:()=>a,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"quickstart/compose_brick_define","title":"compose_brick_define","description":"GitHub \u7bc4\u4f8b\u7a0b\u5f0f\u78bc","source":"@site/docs/quickstart/compose_brick_define.md","sourceDirName":"quickstart","slug":"/quickstart/compose_brick_define","permalink":"/llmbrick/docs/quickstart/compose_brick_define","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7,"sidebar_label":"\u7d44\u5408\u8f49\u63db ComposeBrick \u5b9a\u7fa9"},"sidebar":"quickstartSidebar","previous":{"title":"\u6aa2\u7d22\u578b RetrievalBrick \u5b9a\u7fa9","permalink":"/llmbrick/docs/quickstart/retrieval_brick_define"},"next":{"title":"\u7ffb\u8b6f TranslateBrick \u5b9a\u7fa9","permalink":"/llmbrick/docs/quickstart/translate_brick_define"}}');var o=n(4848),i=n(8453);const t={sidebar_position:7,sidebar_label:"\u7d44\u5408\u8f49\u63db ComposeBrick \u5b9a\u7fa9"},c="\u5b9a\u7fa9\u8207\u4f7f\u7528 ComposeBrick",p={},d=[{value:"1. \u4ec0\u9ebc\u662f ComposeBrick\uff1f",id:"1-\u4ec0\u9ebc\u662f-composebrick",level:2},{value:"2. \u5be6\u4f5c\u81ea\u8a02 ComposeBrick",id:"2-\u5be6\u4f5c\u81ea\u8a02-composebrick",level:2},{value:"3. \u672c\u5730\u7aef\u547c\u53eb\u7bc4\u4f8b",id:"3-\u672c\u5730\u7aef\u547c\u53eb\u7bc4\u4f8b",level:2},{value:"4. \u4ee5 gRPC \u65b9\u5f0f\u63d0\u4f9b\u670d\u52d9",id:"4-\u4ee5-grpc-\u65b9\u5f0f\u63d0\u4f9b\u670d\u52d9",level:2},{value:"\u555f\u52d5 gRPC \u4f3a\u670d\u5668",id:"\u555f\u52d5-grpc-\u4f3a\u670d\u5668",level:3},{value:"gRPC Client \u547c\u53eb\u9060\u7aef ComposeBrick",id:"grpc-client-\u547c\u53eb\u9060\u7aef-composebrick",level:3},{value:"5. \u65b9\u6cd5\u578b\u614b\u7e3d\u89bd",id:"5-\u65b9\u6cd5\u578b\u614b\u7e3d\u89bd",level:2},{value:"6. \u5be6\u4f5c\u5efa\u8b70\u8207\u6700\u4f73\u5be6\u8e10",id:"6-\u5be6\u4f5c\u5efa\u8b70\u8207\u6700\u4f73\u5be6\u8e10",level:2},{value:"7. \u5e38\u898b\u554f\u984c",id:"7-\u5e38\u898b\u554f\u984c",level:2}];function l(e){const r={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.p,{children:(0,o.jsx)(r.a,{href:"https://github.com/JiHungLin/llmbrick/tree/main/examples/compose_brick_define",children:"GitHub \u7bc4\u4f8b\u7a0b\u5f0f\u78bc"})}),"\n",(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"\u5b9a\u7fa9\u8207\u4f7f\u7528-composebrick",children:"\u5b9a\u7fa9\u8207\u4f7f\u7528 ComposeBrick"})}),"\n",(0,o.jsx)(r.p,{children:"\u672c\u6559\u5b78\u5c07\u8a73\u7d30\u8aaa\u660e\u5982\u4f55\u5728 LLMBrick \u6846\u67b6\u4e2d\u81ea\u8a02\u3001\u5be6\u4f5c\u4e26\u4f7f\u7528 ComposeBrick\u3002\u5167\u5bb9\u6db5\u84cb\u672c\u5730\u7aef\u547c\u53eb\u8207 gRPC \u670d\u52d9\u5169\u7a2e\u60c5\u5883\uff0c\u4e26\u91dd\u5c0d\u5e38\u898b\u65b9\u6cd5\u578b\u614b\uff08Unary\u3001Output Streaming\u3001Service Info\uff09\u63d0\u4f9b\u5b8c\u6574\u7bc4\u4f8b\u8207\u8aaa\u660e\u3002"}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"1-\u4ec0\u9ebc\u662f-composebrick",children:"1. \u4ec0\u9ebc\u662f ComposeBrick\uff1f"}),"\n",(0,o.jsx)(r.p,{children:"ComposeBrick \u662f LLMBrick \u6846\u67b6\u4e2d\u5c08\u70ba\u300c\u591a\u6587\u4ef6\u7d44\u5408\u3001\u6458\u8981\u3001\u683c\u5f0f\u8f49\u63db\u300d\u7b49\u61c9\u7528\u5834\u666f\u8a2d\u8a08\u7684 Brick \u985e\u578b\u3002\u5b83\u652f\u63f4\u591a\u7a2e RPC \u65b9\u6cd5\u578b\u614b\uff0c\u4e26\u53ef\u81ea\u8a02\u63cf\u8ff0\u524d\u7db4\uff08desc_prefix\uff09\u8207\u9810\u8a2d\u683c\u5f0f\uff08default_format\uff09\uff0c\u9069\u5408\u7528\u65bc\u6587\u4ef6\u5f59\u6574\u3001\u6279\u6b21\u8655\u7406\u7b49\u9700\u6c42\u3002"}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"2-\u5be6\u4f5c\u81ea\u8a02-composebrick",children:"2. \u5be6\u4f5c\u81ea\u8a02 ComposeBrick"}),"\n",(0,o.jsxs)(r.p,{children:["\u9996\u5148\uff0c\u5efa\u7acb\u4e00\u500b\u7e7c\u627f\u81ea ",(0,o.jsx)(r.code,{children:"ComposeBrick"})," \u7684\u81ea\u8a02\u985e\u5225\uff0c\u4e26\u5be6\u4f5c\u5404\u7a2e\u65b9\u6cd5\uff1a"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-python",children:'# examples/compose_brick_define/my_brick.py\nfrom typing import AsyncIterator\nfrom llmbrick.bricks.compose.base_compose import ComposeBrick\nfrom llmbrick.protocols.models.bricks.compose_types import ComposeRequest, ComposeResponse\nfrom llmbrick.protocols.models.bricks.common_types import ErrorDetail, ServiceInfoResponse\nfrom llmbrick.core.brick import unary_handler, output_streaming_handler, get_service_info_handler\nfrom llmbrick.core.error_codes import ErrorCodes\n\nclass MyComposeBrick(ComposeBrick):\n    """\n    MyComposeBrick \u662f\u4e00\u500b\u81ea\u8a02\u7684 ComposeBrick \u7bc4\u4f8b\uff0c\u5c55\u793a unary\u3001output_streaming\u3001get_service_info \u4e09\u7a2e\u6a21\u5f0f\u3002\n    \u652f\u63f4\u81ea\u8a02\u63cf\u8ff0\u524d\u7db4(desc_prefix)\u8207\u9810\u8a2d\u683c\u5f0f(default_format)\u3002\n    """\n\n    def __init__(self, desc_prefix: str = "ComposeResult", default_format: str = "json", **kwargs):\n        super().__init__(**kwargs)\n        self.desc_prefix = desc_prefix\n        self.default_format = default_format\n\n    @unary_handler\n    async def unary_process(self, request: ComposeRequest) -> ComposeResponse:\n        try:\n            count = len(request.input_documents)\n            fmt = request.target_format or self.default_format\n            return ComposeResponse(\n                output={\n                    "desc": f"{self.desc_prefix}: \u5171 {count} \u7b46\u6587\u4ef6, \u683c\u5f0f: {fmt}",\n                    "count": count,\n                    "format": fmt\n                },\n                error=ErrorDetail(code=ErrorCodes.SUCCESS, message="Success")\n            )\n        except Exception as e:\n            return ComposeResponse(\n                output={},\n                error=ErrorDetail(code=ErrorCodes.INTERNAL_ERROR, message=f"Error: {e}")\n            )\n\n    @output_streaming_handler\n    async def stream_titles(self, request: ComposeRequest) -> AsyncIterator[ComposeResponse]:\n        try:\n            for idx, doc in enumerate(request.input_documents):\n                yield ComposeResponse(\n                    output={\n                        "desc": f"{self.desc_prefix}: \u7b2c{idx+1}\u7b46",\n                        "index": idx,\n                        "title": getattr(doc, "title", ""),\n                        "format": request.target_format or self.default_format\n                    },\n                    error=ErrorDetail(code=ErrorCodes.SUCCESS, message="Success")\n                )\n        except Exception as e:\n            yield ComposeResponse(\n                output={},\n                error=ErrorDetail(code=ErrorCodes.INTERNAL_ERROR, message=f"Error: {e}")\n            )\n\n    @get_service_info_handler\n    async def get_info(self) -> ServiceInfoResponse:\n        return ServiceInfoResponse(\n            service_name="MyComposeBrick",\n            version="1.0.0",\n            models=[],\n            error=ErrorDetail(code=ErrorCodes.SUCCESS, message=f"Default format: {self.default_format}, Desc prefix: {self.desc_prefix}")\n        )\n'})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"3-\u672c\u5730\u7aef\u547c\u53eb\u7bc4\u4f8b",children:"3. \u672c\u5730\u7aef\u547c\u53eb\u7bc4\u4f8b"}),"\n",(0,o.jsx)(r.p,{children:"\u76f4\u63a5\u65bc Python \u7a0b\u5f0f\u4e2d\u5be6\u4f8b\u5316\u4e26\u547c\u53eb ComposeBrick\uff0c\u9069\u5408\u55ae\u5143\u6e2c\u8a66\u6216\u5d4c\u5165\u5f0f\u61c9\u7528\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-python",children:'# examples/compose_brick_define/local_use.py\nimport asyncio\nfrom my_brick import MyComposeBrick\nfrom llmbrick.protocols.models.bricks.compose_types import ComposeRequest\n\nasync def main():\n    brick = MyComposeBrick(desc_prefix="DemoPrefix", default_format="yaml", verbose=False)\n    docs = [\n        type("Doc", (), {"doc_id": "1", "title": "A", "snippet": "", "score": 1.0, "metadata": {}})(),\n        type("Doc", (), {"doc_id": "2", "title": "B", "snippet": "", "score": 2.0, "metadata": {}})(),\n    ]\n    request = ComposeRequest(input_documents=docs, target_format="json")\n\n    print("=== Unary Method ===")\n    try:\n        response = await brick.run_unary(request)\n        print(f"Unary result: {response.output.get(\'count\')}, desc: {response.output.get(\'desc\')}, error: {response.error}")\n    except Exception as e:\n        print(f"Error in unary: {e}")\n\n    print("\\n=== Output Streaming Method ===")\n    try:\n        async for response in brick.run_output_streaming(request):\n            print(f"Stream output: {response.output}, error: {response.error}")\n    except Exception as e:\n        print(f"Error in output streaming: {e}")\n\n    print("\\n=== Get Service Info ===")\n    try:\n        info = await brick.run_get_service_info()\n        print(f"Service name: {info.service_name}, version: {info.version}, info: {info.error.message}")\n    except Exception as e:\n        print(f"Error in get_service_info: {e}")\n\nif __name__ == "__main__":\n    asyncio.run(main())\n'})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"4-\u4ee5-grpc-\u65b9\u5f0f\u63d0\u4f9b\u670d\u52d9",children:"4. \u4ee5 gRPC \u65b9\u5f0f\u63d0\u4f9b\u670d\u52d9"}),"\n",(0,o.jsx)(r.h3,{id:"\u555f\u52d5-grpc-\u4f3a\u670d\u5668",children:"\u555f\u52d5 gRPC \u4f3a\u670d\u5668"}),"\n",(0,o.jsx)(r.p,{children:"\u5c07\u81ea\u8a02 ComposeBrick \u8a3b\u518a\u5230 gRPC \u4f3a\u670d\u5668\uff0c\u5c0d\u5916\u63d0\u4f9b\u9060\u7aef\u547c\u53eb\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-python",children:'# examples/compose_brick_define/grpc_server.py\nfrom my_brick import MyComposeBrick\nfrom llmbrick.servers.grpc.server import GrpcServer\n\ngrpc_server = GrpcServer(port=50051)\nmy_brick = MyComposeBrick(desc_prefix="GRPCServer", default_format="xml", verbose=True)\ngrpc_server.register_service(my_brick)\n\nif __name__ == "__main__":\n    import asyncio\n    asyncio.run(grpc_server.start())\n'})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h3,{id:"grpc-client-\u547c\u53eb\u9060\u7aef-composebrick",children:"gRPC Client \u547c\u53eb\u9060\u7aef ComposeBrick"}),"\n",(0,o.jsxs)(r.p,{children:["\u53ef\u900f\u904e ",(0,o.jsx)(r.code,{children:"ComposeBrick.toGrpcClient"})," \u7522\u751f\u9060\u7aef\u4ee3\u7406\u7269\u4ef6\uff0c\u4e26\u4ee5 async \u65b9\u5f0f\u547c\u53eb\u5404\u7a2e\u65b9\u6cd5\uff1a"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-python",children:'# examples/compose_brick_define/grpc_client.py\nfrom my_brick import MyComposeBrick\nfrom llmbrick.protocols.models.bricks.compose_types import ComposeRequest\nimport asyncio\n\nasync def main():\n    client_brick = MyComposeBrick.toGrpcClient(\n        remote_address="127.0.0.1:50051",\n        desc_prefix="GRPCClient",\n        default_format="csv",\n        verbose=False\n    )\n    docs = [\n        type("Doc", (), {"doc_id": "1", "title": "A", "snippet": "", "score": 1.0, "metadata": {}})(),\n        type("Doc", (), {"doc_id": "2", "title": "B", "snippet": "", "score": 2.0, "metadata": {}})(),\n    ]\n    request = ComposeRequest(input_documents=docs, target_format="json")\n\n    print("=== Get Service Info ===")\n    try:\n        info = await client_brick.run_get_service_info()\n        print(f"Service name: {info.service_name}, version: {info.version}, info: {info.error.message}")\n    except Exception as e:\n        print(f"Error in get_service_info: {e}")\n\n    print("\\n=== Unary Method ===")\n    try:\n        response = await client_brick.run_unary(request)\n        print(f"Unary result: {response.output.get(\'count\')}, desc: {response.output.get(\'desc\')}, error: {response.error}")\n    except Exception as e:\n        print(f"Error in unary: {e}")\n\n    print("\\n=== Output Streaming Method ===")\n    try:\n        async for response in client_brick.run_output_streaming(request):\n            print(f"Stream output: {response.output}, error: {response.error}")\n    except Exception as e:\n        print(f"Error in output streaming: {e}")\n\nif __name__ == "__main__":\n    asyncio.run(main())\n'})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"5-\u65b9\u6cd5\u578b\u614b\u7e3d\u89bd",children:"5. \u65b9\u6cd5\u578b\u614b\u7e3d\u89bd"}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"\u65b9\u6cd5\u578b\u614b"}),(0,o.jsx)(r.th,{children:"\u88dd\u98fe\u5668"}),(0,o.jsx)(r.th,{children:"\u8aaa\u660e"}),(0,o.jsx)(r.th,{children:"\u7bc4\u4f8b\u547c\u53eb\u65b9\u5f0f"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:"Unary"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"@unary_handler"})}),(0,o.jsx)(r.td,{children:"\u4e00\u6b21\u8acb\u6c42/\u56de\u61c9"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"await run_unary(request)"})})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:"Output Streaming"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"@output_streaming_handler"})}),(0,o.jsx)(r.td,{children:"\u4e00\u6b21\u8f38\u5165\uff0c\u591a\u6b21\u56de\u61c9"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"async for r in run_output_streaming(request)"})})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:"Service Info"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"@get_service_info_handler"})}),(0,o.jsx)(r.td,{children:"\u67e5\u8a62\u670d\u52d9\u8cc7\u8a0a"}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"await run_get_service_info()"})})]})]})]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"6-\u5be6\u4f5c\u5efa\u8b70\u8207\u6700\u4f73\u5be6\u8e10",children:"6. \u5be6\u4f5c\u5efa\u8b70\u8207\u6700\u4f73\u5be6\u8e10"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"\u578b\u5225\u8a3b\u8a18"}),"\uff1a\u5efa\u8b70\u660e\u78ba\u6a19\u8a3b\u6240\u6709\u65b9\u6cd5\u7684\u8f38\u5165/\u8f38\u51fa\u578b\u5225\uff0c\u63d0\u5347\u53ef\u8b80\u6027\u8207\u7dad\u8b77\u6027\u3002"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"\u932f\u8aa4\u8655\u7406"}),"\uff1a\u5584\u7528 ",(0,o.jsx)(r.code,{children:"ErrorDetail"})," \u56de\u50b3\u6a19\u6e96\u5316\u932f\u8aa4\u8cc7\u8a0a\uff0c\u65b9\u4fbf\u524d\u5f8c\u7aef\u5354\u4f5c\u3002"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"\u975e\u540c\u6b65\u8a2d\u8a08"}),"\uff1a\u6240\u6709\u65b9\u6cd5\u7686\u5efa\u8b70\u4f7f\u7528 async/await\uff0c\u78ba\u4fdd\u9ad8\u6548\u80fd\u8207\u53ef\u64f4\u5145\u6027\u3002"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"\u4e32\u6d41\u8655\u7406"}),"\uff1a\u4e32\u6d41\u65b9\u6cd5\u53ef\u7528\u65bc\u5927\u91cf\u8cc7\u6599\u3001\u9577\u6642\u9593\u4efb\u52d9\u7b49\u5834\u666f\uff0c\u5584\u7528 async generator\u3002"]}),"\n"]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"7-\u5e38\u898b\u554f\u984c",children:"7. \u5e38\u898b\u554f\u984c"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Q: \u5982\u4f55\u81ea\u8a02\u56de\u61c9\u683c\u5f0f\u6216\u63cf\u8ff0\uff1f"}),(0,o.jsx)(r.br,{}),"\n","A: \u65bc ",(0,o.jsx)(r.code,{children:"MyComposeBrick.__init__"})," \u8a2d\u5b9a ",(0,o.jsx)(r.code,{children:"desc_prefix"})," \u8207 ",(0,o.jsx)(r.code,{children:"default_format"}),"\uff0c\u6216\u65bc\u65b9\u6cd5\u4e2d\u4f9d\u9700\u6c42\u8abf\u6574\u3002"]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Q: \u5982\u4f55\u4e32\u63a5\u591a\u500b ComposeBrick\uff1f"}),(0,o.jsx)(r.br,{}),"\n","A: \u53ef\u65bc\u4f3a\u670d\u5668\u7aef\u8a3b\u518a\u591a\u500b Brick\uff0c\u6216\u65bc client \u7aef\u5efa\u7acb\u591a\u500b\u4ee3\u7406\u7269\u4ef6\u3002"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.p,{children:["\u672c\u6559\u5b78\u6db5\u84cb\u4e86 ComposeBrick \u7684\u5b9a\u7fa9\u3001\u5be6\u4f5c\u8207\u4f7f\u7528\u6d41\u7a0b\uff0c\u9069\u5408\u521d\u5b78\u8005\u8207\u9032\u968e\u958b\u767c\u8005\u5feb\u901f\u4e0a\u624b LLMBrick \u6846\u67b6\u7684\u7d44\u5408\u578b\u6a21\u7d44\u958b\u767c\u3002\u5b8c\u6574\u7bc4\u4f8b\u8acb\u53c3\u8003 ",(0,o.jsx)(r.a,{href:"https://github.com/JiHungLin/llmbrick/tree/main/examples/compose_brick_define",children:(0,o.jsx)(r.code,{children:"examples/compose_brick_define/"})})," \u76ee\u9304\u3002"]})]})}function a(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>c});var s=n(6540);const o={},i=s.createContext(o);function t(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);